<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Know Your Handpan</title>
    <meta name="description"
        content="Explore harmonic possibilities with Know Your Handpan. A premium visual tool for musicians.">
    <!-- Google Fonts: Outfit for headings, Inter for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Handpan">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Background Animation -->
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <main class="app-container">
        <header class="glass-header">
            <div class="header-content">
                <div class="header-title-row">
                    <h1>Know Your Handpan</h1>
                    <button id="theme-toggle" class="theme-toggle-btn" title="Toggle Light/Dark Mode">ðŸŒž</button>
                </div>
                <div class="header-subtitle-row">
                    <span id="scale-picker-trigger" class="scale-info-text" title="Change Scale">
                        <span id="current-scale-display">E Amara â€¢ G3 F#3</span>
                    </span>
                    <button id="viz-toggle" class="viz-toggle-btn" title="Toggle Handpan Diagram">â–²</button>
                </div>
            </div>
            <div class="header-controls">
                <!-- Global controls removed, moved to progression header -->
            </div>
        </header>

        <!-- Visualizer Section -->
        <section id="visualizer-section" class="visualizer-section">
            <div class="handpan-container">
                <button id="canvas-play-btn" class="canvas-play-btn" title="Play">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </button>
                <button id="viz-fullscreen-btn" class="viz-fullscreen-btn" title="Toggle Fullscreen">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                    </svg>
                </button>
                <svg id="handpan-svg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet">
                    <!-- Definitions for metallic gradient -->
                    <defs>
                        <radialGradient id="metallic-gradient" cx="50%" cy="50%" r="50%" fx="35%" fy="30%">
                            <stop offset="0%" stop-color="#f8f9fa" />
                            <stop offset="50%" stop-color="#e2e6ea" />
                            <stop offset="90%" stop-color="#ced4da" />
                            <stop offset="100%" stop-color="#adb5bd" />
                        </radialGradient>
                    </defs>

                    <!-- Main Body -->
                    <circle cx="250" cy="250" r="165" class="hp-body" />

                    <!-- Bottom Side Notes Marker (Dashed line) -->
                    <circle cx="250" cy="250" r="185" fill="none" stroke="var(--glass-border)" stroke-dasharray="4 4"
                        opacity="0.4" />

                    <!-- Ding (Center) -->
                    <g id="note-E3" class="hp-note ding" data-note="E3">
                        <circle cx="250" cy="250" r="48" class="note-area" />
                        <text x="250" y="255" text-anchor="middle" class="note-label">E3</text>
                    </g>

                    <!-- Side Notes (Zigzag Layout) -->
                    <!-- B3: Immediately below E3 -->
                    <g id="note-B3" class="hp-note" data-note="B3">
                        <circle cx="250" cy="375" r="32" class="note-area" />
                        <text x="250" y="380" text-anchor="middle" class="note-label">B3</text>
                    </g>
                    <!-- D4: Left of B3, E4: Right of B3 -->
                    <g id="note-D4" class="hp-note" data-note="D4">
                        <circle cx="165" cy="355" r="30" class="note-area" />
                        <text x="165" y="360" text-anchor="middle" class="note-label">D4</text>
                    </g>
                    <g id="note-E4" class="hp-note" data-note="E4">
                        <circle cx="335" cy="355" r="30" class="note-area" />
                        <text x="335" y="360" text-anchor="middle" class="note-label">E4</text>
                    </g>
                    <!-- F#4: Middle Left, G4: Middle Right -->
                    <g id="note-F#4" class="hp-note" data-note="F#4">
                        <circle cx="130" cy="260" r="30" class="note-area" />
                        <text x="130" y="265" text-anchor="middle" class="note-label">F#4</text>
                    </g>
                    <g id="note-G4" class="hp-note" data-note="G4">
                        <circle cx="370" cy="260" r="30" class="note-area" />
                        <text x="370" y="265" text-anchor="middle" class="note-label">G4</text>
                    </g>
                    <!-- A4: Upper Left, B4: Upper Right -->
                    <g id="note-A4" class="hp-note" data-note="A4">
                        <circle cx="170" cy="175" r="30" class="note-area" />
                        <text x="170" y="180" text-anchor="middle" class="note-label">A4</text>

                    </g>
                    <g id="note-B4" class="hp-note" data-note="B4">
                        <circle cx="330" cy="175" r="30" class="note-area" />
                        <text x="330" y="180" text-anchor="middle" class="note-label">B4</text>
                    </g>
                    <!-- D5: Top Centerish -->
                    <g id="note-D5" class="hp-note" data-note="D5">
                        <circle cx="250" cy="135" r="30" class="note-area" />
                        <text x="250" y="140" text-anchor="middle" class="note-label">D5</text>
                    </g>

                    <!-- Bottom Shell Notes (Outside the circle) -->
                    <!-- F#3: Outside Left of F#4 -->
                    <g id="note-F#3" class="hp-note side-note" data-note="F#3">
                        <circle cx="75" cy="255" r="22" class="note-area" />
                        <text x="75" y="259" text-anchor="middle" class="note-label-small">F#3</text>
                    </g>
                    <!-- G3: Outside Right of G4 -->
                    <g id="note-G3" class="hp-note side-note" data-note="G3">
                        <circle cx="425" cy="255" r="22" class="note-area" />
                        <text x="425" y="259" text-anchor="middle" class="note-label-small">G3</text>
                    </g>
                    <!-- E5: Above and Right of B4 -->
                    <g id="note-E5" class="hp-note side-note" data-note="E5">
                        <circle cx="390" cy="120" r="22" class="note-area" />
                        <text x="390" y="124" text-anchor="middle" class="note-label-small">E5</text>
                    </g>
                </svg>
                <button id="vis-label-toggle-btn" class="icon-toggle-btn"
                    title="Toggle Labels: Notes / Numbers / Degrees"
                    style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.4); color:white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; z-index: 100;">
                    ABC
                </button>
            </div>
        </section>

        <!-- Progression Stage -->
        <section class="progression-section">
            <div class="progression-header">
                <div class="progression-left-group">
                    <h3 class="section-title">Progression Stage</h3>
                    <div class="header-actions">
                        <button id="add-custom-chord" class="clear-btn add" title="Add Musical Phrase">+</button>
                        <button id="save-comp-btn" class="clear-btn" title="Save Composition">ðŸ’¾</button>
                        <button id="load-comp-btn" class="clear-btn" title="Load Composition">ðŸ“‚</button>
                        <button id="share-progression" class="clear-btn" title="Share Progression Link">ðŸ”—</button>
                        <button id="clear-progression" class="clear-btn" title="Clear All">â€“</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button id="help-save-share-btn" class="icon-btn" title="How to Save & Share"
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; width: 28px; height: 28px; font-size: 0.8rem; flex-shrink: 0; color: var(--text-main); display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;">?</button>
                        <button id="play-progression-btn" class="premium-btn" title="Play"
                            style="padding: 10px 0; font-size: 0.95rem; width: 120px; text-align: center;">
                            Play â–¶
                        </button>
                    </div>
                </div>
                <div class="progression-right-group">
                    <div class="control-group">
                        <label>BPM: <span id="bpm-value">80</span></label>
                        <input type="range" id="bpm-slider" min="30" max="280" value="80">
                    </div>
                    <input type="number" id="repeat-count" value="2" style="display: none;">
                </div>
            </div>
            <div id="progression-stage" class="progression-stage">
                <!-- Selected chords will appear here -->
                <div class="placeholder-text">Click + on a card to add to progression</div>
            </div>
        </section>

        <div class="glass-header chord-panel-header"
            style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 20px;">
            <h2 style="margin:0; font-size: 1.2rem; background: none; -webkit-text-fill-color: var(--text-main);">
                Available Chords</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="sort-chords-btn" class="icon-btn" title="Sort by Pitch / Group"
                    style="font-size: 1rem; opacity: 0.7; display: block;">â‡…</button>
                <button id="chord-toggle-btn" class="viz-toggle-btn" style="font-size: 1.2rem;">â–²</button>
            </div>
        </div>

        <section id="chord-grid" class="card-grid">
            <!-- Dynamic Content -->
        </section>
    </main>

    <!-- App Footer -->
    <footer class="app-footer glass-card">
        <p>Created by <strong>Alex Ostapenko</strong></p>
        <p>Questions or suggestions? Contact: <a href="mailto:tvoyritm@gmail.com"
                class="footer-link">tvoyritm@gmail.com</a></p>
    </footer>

    <!-- Welcome / Audio Init Overlay -->
    <div id="welcome-overlay" class="welcome-overlay">
        <div class="welcome-card glass-card">
            <h2 class="welcome-title">Welcome</h2>
            <p class="welcome-text">Here you will learn to understand your handpan and play it better!</p>
            <button id="btn-start-app" class="premium-btn start-btn">Start</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay"></div>

    <!-- Scale Selection Modal -->
    <div id="scale-modal" class="modal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h2>Select Scale Type</h2>
                <span class="close-modal" id="close-scale-modal">&times;</span>
            </div>
            <div
                style="font-size: 0.8rem; font-weight: 600; color: #888; margin-bottom: 10px; padding-left: 5px; text-transform: uppercase; letter-spacing: 1px;">
                Scale Library</div>
            <div id="scale-list" class="scale-list">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button id="btn-custom-scale" class="premium-btn"
                    style="margin-top: 20px; width: 100%; background: #fff; color: #000;">Create Custom Handpan
                    +</button>
            </div>
        </div>
    </div>

    <!-- Custom Scale Modal -->
    <div id="custom-scale-modal" class="modal">
        <div class="modal-content glass-card large">
            <div class="modal-header">
                <h2>Custom Handpan</h2>
                <span class="close-modal" id="close-custom-modal">&times;</span>
            </div>
            <div class="custom-scale-form">
                <div class="input-group">
                    <label>Scale Name</label>
                    <input type="text" id="custom-scale-name" placeholder="e.g. My Mystic D" class="premium-text-input">
                </div>
                <div class="input-group">
                    <label style="display: block; margin-top: 15px;">Top Shell Notes (First is Ding)</label>
                    <p class="input-hint">Space separated, e.g: D3 A3 Bb3 C4 D4 E4 F4 G4 A4</p>
                    <input type="text" id="custom-scale-top" placeholder="D3 A3 Bb3..." class="premium-text-input">
                </div>
                <div class="input-group">
                    <label style="display: block; margin-top: 15px;">Bottom Shell Notes (Optional)</label>
                    <p class="input-hint">Format: Note(Parent), e.g: F#3(F#4) G3(G4)</p>
                    <input type="text" id="custom-scale-bottom" placeholder="E5(B4) F#3(F#4)..."
                        class="premium-text-input">
                </div>
                <div class="form-actions">
                    <button id="save-custom-scale" class="premium-btn"
                        style="background: var(--accent-color); color: #000;">Build My Handpan!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voicing Modal -->
    <div id="voicing-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h2 id="voicing-modal-title">Chord Options</h2>
                <button id="close-voicing-modal" class="close-btn">&times;</button>
            </div>
            <div id="voicing-list" class="modal-body">
                <!-- Voicings go here -->
            </div>
        </div>
    </div>

    <!-- Save/Share Help Modal -->
    <div id="save-share-help-modal" class="modal-overlay" style="display: none; z-index: 2200;">
        <div class="modal-content glass-card" style="max-width: 450px; padding: 25px;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.4rem; font-weight: 700; color: var(--text-main); margin: 0;">How to Save & Share
                </h2>
                <button id="close-save-share-help" class="close-btn" style="top: -5px; right: 0;">&times;</button>
            </div>
            <div class="modal-body"
                style="display: flex; flex-direction: column; gap: 10px; font-size: 0.95rem; line-height: 1.5; color: var(--text-main);">
                <p style="margin-bottom: 4px; font-size: 1.05rem;">It's exciting, you can save your compositions and
                    share them with friends!</p>

                <p><strong>ðŸ’¾ Local Saving:</strong><br>
                    Click the Floppy Disk icon to save your current Progression Stage.
                    Compositions are saved <em>locally</em> in your web browser.
                    If you clear your browser's data or use a different device, your saved songs won't be there.</p>

                <p><strong>ðŸ“‚ Loading:</strong><br>
                    Click the Folder icon to view and load your saved compositions. You can organize them by adding a
                    category name when saving.</p>

                <p><strong>ðŸ”— Sharing with Friends:</strong><br>
                    Click the Link icon to generate a special URL containing your exact melody and handpan scale.
                    When you share this link, anyone who opens it will see your progression loaded automatically, even
                    if they've never visited the site before!</p>

                <div class="modal-footer" style="display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button class="premium-btn close-save-share-btn-secondary"
                        style="border-radius: 20px; padding: 8px 20px;">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="editor-modal" class="modal-overlay" style="display: none; z-index: 2000;">
        <div class="modal-content glass-card" style="max-width: 420px; padding: 25px;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin: 0;">Edit Musical Phrase
                </h2>
                <button id="close-editor-modal" class="close-btn" style="top: -5px; right: 0;">&times;</button>
            </div>

            <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Part Name Input -->
                <input type="text" id="editor-name" placeholder="Part Name (e.g. Intro)" class="premium-text-input"
                    style="font-size: 1.05rem; padding: 14px; background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0,0,0,0.1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02)">

                <!-- Hint Text Box -->
                <div
                    style="background: rgba(0,0,0,0.02); border-radius: 12px; padding: 12px 14px; display: flex; align-items: flex-start; gap: 10px; border: 1px solid rgba(0,0,0,0.05);">
                    <p style="font-size: 0.8rem; opacity: 0.7; margin: 0; line-height: 1.4; flex: 1;">
                        Enter notes ("E3 G3 B3") or numbers ("1 2 3"). "D" for ding. For pause use "-" , "T" and "K" are
                        body hits.
                    </p>
                    <button id="editor-notation-info-btn" class="icon-btn"
                        style="background: white; border: 1px solid #eee; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; flex-shrink: 0; color: #555; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);"
                        title="Detailed Notation Info">?</button>
                </div>

                <!-- Fast Insert Buttons -->
                <div id="editor-fast-insert-buttons" style="display: flex; flex-wrap: wrap; gap: 6px;">
                    <!-- Buttons will be injected here by JS, but we will style them nicer via JS -->
                </div>

                <!-- Main Textarea -->
                <textarea id="editor-input" rows="3" class="premium-text-input"
                    style="font-family: monospace; font-size: 1.1rem; resize: vertical; min-height: 80px; padding: 14px; background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0,0,0,0.1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);"></textarea>

                <!-- Repeats and Actions Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <div
                        style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.03); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05);">
                        <label style="font-size: 0.85rem; font-weight: 500; opacity: 0.7;">Repeats</label>
                        <input type="number" id="editor-repeats" min="1" max="16" value="1"
                            style="width: 40px; border: none; background: transparent; font-size: 1rem; font-weight: bold; color: var(--text-main); text-align: center; outline: none; -moz-appearance: textfield; appearance: none;">
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="editor-cancel-btn"
                            style="background: transparent; border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; padding: 8px 16px; font-size: 0.9rem; cursor: pointer; color: var(--text-main); transition: background 0.2s;">Cancel</button>
                        <button id="editor-save-btn" class="premium-btn"
                            style="border-radius: 20px; padding: 8px 20px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);">Save</button>
                    </div>
                </div>

                <!-- Mini diagram injected here via JS -->
                <div id="editor-mini-handpan" class="mini-handpan-container" style="margin-top: 10px;">
                </div>
            </div>
        </div>
    </div>
    <!-- Save Composition Modal -->
    <div id="save-comp-modal" class="modal-overlay" style="display: none; z-index: 2100;">
        <div class="modal-content glass-card" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Save Composition</h2>
                <button id="close-save-comp" class="close-btn">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-size: 0.9rem; opacity: 0.8;">Composition Name</label>
                    <input type="text" id="save-comp-name" placeholder="e.g. My First Song" class="premium-text-input">
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-size: 0.9rem; opacity: 0.8;">Category (Optional)</label>
                    <input type="text" id="save-comp-category" placeholder="e.g. Ideas, Covers"
                        class="premium-text-input">
                </div>
                <div class="modal-footer"
                    style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <button id="cancel-save-comp" class="secondary-btn">Cancel</button>
                    <button id="confirm-save-comp" class="premium-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Composition Modal -->
    <div id="load-comp-modal" class="modal-overlay" style="display: none; z-index: 2100;">
        <div class="modal-content glass-card"
            style="max-width: 500px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>Load Composition</h2>
                <button id="close-load-comp" class="close-btn">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                <div id="compositions-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Categories and items injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notation Info Modal -->
    <div id="notation-info-modal" class="modal-overlay" style="display: none; z-index: 2200;">
        <div class="modal-content glass-card" style="max-width: 450px; padding: 20px;">
            <div class="modal-header">
                <h2>Notation Guide</h2>
                <button id="close-notation-info" class="close-btn">&times;</button>
            </div>
            <div class="modal-body"
                style="font-size: 0.9rem; line-height: 1.5; color: var(--text-color); opacity: 0.9;">
                <div style="margin-bottom: 8px;"><strong>Notes:</strong> Enter literal notes like <code>E3 G3</code>, or
                    numbers based on the scale:
                    <code>1 2 3</code>.
                </div>
                <div style="margin-bottom: 8px;"><strong>Ding:</strong> The lowest central note. Enter as
                    <code>D</code>.
                </div>
                <div style="margin-bottom: 8px;"><strong>Pauses:</strong> Enter <code>-</code> for a rest/pause.</div>
                <div style="margin-bottom: 8px;"><strong>Percussion (Body Hits):</strong></div>
                <ul style="margin-top: 5px; margin-bottom: 15px; padding-left: 20px;">
                    <li><code>T</code>: Right hand Tak (bright slap)</li>
                    <li><code>K</code>: Left hand Tak (bright slap)</li>
                    <li><code>t</code>: Right hand ghost note (soft hit)</li>
                    <li><code>k</code>: Left hand ghost note (soft hit)</li>
                </ul>
                <div style="margin-bottom: 8px;"><strong>Bars:</strong> Use <code>|</code> without spaces to play notes
                    simultaneously (e.g.,
                    <code>1|3|5</code> plays a chord).
                </div>
                <div style="margin-bottom: 8px;"><strong>Faster Notes:</strong> Wrap a part of the phrase in parentheses
                    and append <code>/2</code> to
                    play it twice as fast, or <code>/4</code> for four times as fast. E.g.,
                    <code>D (1 3)/2 D (6 5 4 3)/4</code>.
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Update Banner -->
    <div id="pwa-update-banner" class="update-banner" style="display: none;">
        <span>A new version is available!</span>
        <button id="pwa-reload-btn" class="premium-btn" style="padding: 5px 15px; font-size: 0.9rem;">Update</button>
    </div>

    <script type="module" src="js/main.js?v=2"></script>
</body>

</html>